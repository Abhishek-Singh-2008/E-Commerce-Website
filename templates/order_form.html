<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order {{ product.name }} - Banaras Bartan</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Custom CSS -->
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
        <img src="https://i.postimg.cc/bJMg6rx4/Whats-App-Image-2025-07-11-at-3-19-00-PM.jpg" 
             alt="Logo" class="navbar-logo me-2 rounded-circle">
        <div>
          <span class="brand-name">Banaras Bartan</span>
          <small class="brand-tagline d-block text-warning">Order Form</small>
        </div>
      </a>
      
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="{{ url_for('index') }}">
          <i class="fas fa-arrow-left me-1"></i>Back to Store
        </a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mt-4 mb-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
              <i class="fas fa-shopping-cart me-2"></i>Place Your Order
            </h4>
          </div>
          <div class="card-body">
            <!-- Product Info -->
            <div class="row mb-4">
              <div class="col-md-4">
                <img src="{{ product.image }}" alt="{{ product.name }}" class="img-fluid rounded">
              </div>
              <div class="col-md-8">
                <h5>{{ product.name }}</h5>
                <p class="text-muted">{{ product.description }}</p>
                <div class="h4 text-success">₹{{ product.price }}</div>
              </div>
            </div>

            <!-- Order Form -->
            <form id="orderForm">
              <input type="hidden" id="productId" value="{{ product.id }}">
              
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Your Name *</label>
                    <input type="text" class="form-control" id="customerName" required>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" class="form-control" id="customerPhone" required>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Email (Optional)</label>
                    <input type="email" class="form-control" id="customerEmail">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Quantity</label>
                    <input type="number" class="form-control" id="quantity" min="1" value="1" onchange="updateTotal()">
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Address *</label>
                <textarea class="form-control" id="customerAddress" rows="3" required placeholder="Enter your full address for delivery"></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">Payment Method *</label>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="paymentMethod" id="paymentUPI" value="upi" checked>
                      <label class="form-check-label" for="paymentUPI">
                        <i class="fas fa-qrcode me-2"></i>UPI Payment
                      </label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="paymentMethod" id="paymentWhatsApp" value="whatsapp">
                      <label class="form-check-label" for="paymentWhatsApp">
                        <i class="fab fa-whatsapp me-2"></i>WhatsApp Order
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mb-3" id="upiTransactionSection">
                <label class="form-label">UPI Transaction ID (After Payment)</label>
                <input type="text" class="form-control" id="upiTransactionId" placeholder="Enter UPI transaction ID after payment">
                <small class="text-muted">Please make payment first, then enter the transaction ID</small>
              </div>

              <div class="mb-3">
                <label class="form-label">Additional Notes (Optional)</label>
                <textarea class="form-control" id="notes" rows="2" placeholder="Any special instructions or notes"></textarea>
              </div>

              <!-- Order Summary -->
              <div class="card bg-light mb-3">
                <div class="card-body">
                  <h6>Order Summary</h6>
                  <div class="d-flex justify-content-between">
                    <span>{{ product.name }} x <span id="summaryQuantity">1</span></span>
                    <span>₹<span id="summaryPrice">{{ product.price }}</span></span>
                  </div>
                  <hr>
                  <div class="d-flex justify-content-between h5">
                    <span>Total Amount</span>
                    <span class="text-success">₹<span id="totalAmount">{{ product.price }}</span></span>
                  </div>
                </div>
              </div>

              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-success btn-lg">
                  <i class="fas fa-check me-2"></i>Place Order
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                  <i class="fas fa-arrow-left me-2"></i>Back to Products
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="loading-spinner d-none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const productPrice = Number("{{ product.price }}");

    // Update total when quantity changes
    function updateTotal() {
      const quantity = document.getElementById('quantity').value;
      const total = productPrice * quantity;
      
      document.getElementById('summaryQuantity').textContent = quantity;
      document.getElementById('summaryPrice').textContent = productPrice * quantity;
      document.getElementById('totalAmount').textContent = total;
    }

    // Toggle UPI transaction section
    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const upiSection = document.getElementById('upiTransactionSection');
        if (this.value === 'upi') {
          upiSection.style.display = 'block';
        } else {
          upiSection.style.display = 'none';
        }
      });
    });

    // Handle form submission
    document.getElementById('orderForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = {
        product_id: document.getElementById('productId').value,
        customer_name: document.getElementById('customerName').value,
        customer_phone: document.getElementById('customerPhone').value,
        customer_email: document.getElementById('customerEmail').value,
        quantity: document.getElementById('quantity').value,
        customer_address: document.getElementById('customerAddress').value,
        payment_method: document.querySelector('input[name="paymentMethod"]:checked').value,
        upi_transaction_id: document.getElementById('upiTransactionId').value,
        notes: document.getElementById('notes').value
      };

      // Validate required fields
      if (!formData.customer_name || !formData.customer_phone || !formData.customer_address) {
        showAlert('Please fill in all required fields', 'warning');
        return;
      }

      if (formData.payment_method === 'upi' && !formData.upi_transaction_id) {
        showAlert('Please enter UPI transaction ID after making payment', 'warning');
        return;
      }

      showLoading();

      try {
        const response = await fetch('/order/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
          showAlert('Order placed successfully!', 'success');
          setTimeout(() => {
            window.location.href = '/payment-confirmation';
          }, 1500);
        } else {
          showAlert(data.message || 'Error placing order', 'danger');
        }
      } catch (error) {
        console.error('Error placing order:', error);
        showAlert('Error placing order. Please try again.', 'danger');
      } finally {
        hideLoading();
      }
    });

    // Show loading
    function showLoading() {
      document.getElementById('loadingSpinner').classList.remove('d-none');
    }

    // Hide loading
    function hideLoading() {
      document.getElementById('loadingSpinner').classList.add('d-none');
    }

    // Show alert
    function showAlert(message, type = 'info') {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
      alert.style.top = '20px';
      alert.style.right = '20px';
      alert.style.zIndex = '9999';
      alert.style.minWidth = '300px';
      
      alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alert);
      
      setTimeout(() => {
        if (alert.parentNode) {
          alert.remove();
        }
      }, 5000);
    }
  </script>

</body>
</html>
