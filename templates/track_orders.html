{% extends "base.html" %}

{% block title %}Track Your Order - CookwareCraft{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card shadow">
                <div class="card-header bg-info text-white text-center">
                    <h4 class="mb-0"><i class="fas fa-search me-2"></i>Track Your Order</h4>
                </div>
                <div class="card-body">
                    <form id="trackOrderForm">
                        <div class="mb-3">
                            <label for="phoneNumber" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phoneNumber" placeholder="Enter your phone number" required>
                            <div class="form-text">Enter the phone number you used when placing the order</div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="button" class="btn btn-info" onclick="trackOrder()">
                                <i class="fas fa-search me-2"></i>Track Orders
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Results -->
    <div class="row justify-content-center mt-4">
        <div class="col-lg-10">
            <div id="orderResults" style="display: none;">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">Your Orders</h5>
                    </div>
                    <div class="card-body" id="ordersList">
                        <!-- Orders will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function trackOrder() {
    const phoneNumber = document.getElementById('phoneNumber').value.trim();
    
    if (!phoneNumber) {
        showAlert('Please enter your phone number', 'warning');
        return;
    }

    // Show loading
    const submitBtn = event.target;
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Searching...';
    submitBtn.disabled = true;

    fetch('/track-order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ phone: phoneNumber })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayOrders(data.orders);
        } else {
            showAlert('Error: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to track orders. Please try again.', 'danger');
    })
    .finally(() => {
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function displayOrders(orders) {
    const ordersContainer = document.getElementById('ordersList');
    const resultsDiv = document.getElementById('orderResults');
    
    if (orders.length === 0) {
        ordersContainer.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5>No orders found</h5>
                <p class="text-muted">No orders found for this phone number. Please check your phone number and try again.</p>
            </div>
        `;
    } else {
        let ordersHtml = '';
        
        orders.forEach(order => {
            const statusColor = getStatusColor(order.order_status);
            const paymentColor = getPaymentColor(order.payment_status);
            
            ordersHtml += `
                <div class="border rounded p-3 mb-3">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="mb-2">Order #${order.id}</h6>
                            <p class="mb-1"><strong>Product:</strong> ${order.product_name}</p>
                            <p class="mb-1"><strong>Quantity:</strong> ${order.quantity}</p>
                            <p class="mb-1"><strong>Total:</strong> â‚¹${order.total_amount}</p>
                            <p class="mb-1"><strong>Payment Method:</strong> ${order.payment_method}</p>
                            <p class="mb-1"><strong>Order Date:</strong> ${formatDate(order.created_at)}</p>
                            ${order.customer_address ? `<p class="mb-1"><strong>Address:</strong> ${order.customer_address}</p>` : ''}
                            ${order.notes ? `<p class="mb-1"><strong>Notes:</strong> ${order.notes}</p>` : ''}
                        </div>
                        <div class="col-md-4">
                            <div class="text-end">
                                <span class="badge bg-${statusColor} mb-2">
                                    ${order.order_status.charAt(0).toUpperCase() + order.order_status.slice(1)}
                                </span>
                                <br>
                                <span class="badge bg-${paymentColor}">
                                    ${order.payment_status.charAt(0).toUpperCase() + order.payment_status.slice(1)}
                                </span>
                                <div class="mt-2">
                                    ${getStatusIcon(order.order_status)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        ordersContainer.innerHTML = ordersHtml;
    }
    
    resultsDiv.style.display = 'block';
    resultsDiv.scrollIntoView({ behavior: 'smooth' });
}

function getStatusColor(status) {
    const colors = {
        'pending': 'warning',
        'processing': 'info',
        'shipped': 'primary',
        'delivered': 'success',
        'cancelled': 'danger'
    };
    return colors[status] || 'secondary';
}

function getPaymentColor(status) {
    const colors = {
        'pending': 'warning',
        'paid': 'success',
        'failed': 'danger'
    };
    return colors[status] || 'secondary';
}

function getStatusIcon(status) {
    const icons = {
        'pending': '<i class="fas fa-clock text-warning fa-2x"></i>',
        'processing': '<i class="fas fa-cogs text-info fa-2x"></i>',
        'shipped': '<i class="fas fa-shipping-fast text-primary fa-2x"></i>',
        'delivered': '<i class="fas fa-check-circle text-success fa-2x"></i>',
        'cancelled': '<i class="fas fa-times-circle text-danger fa-2x"></i>'
    };
    return icons[status] || '<i class="fas fa-question-circle text-secondary fa-2x"></i>';
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-IN', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Allow Enter key to submit form
document.getElementById('phoneNumber').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        trackOrder();
    }
});
</script>
{% endblock %}
